## æ¶ˆæ¯é˜Ÿåˆ—ä¸å¾®é˜Ÿåˆ—åˆ›å»ºæ—¶æœº

åœ¨ Chromium/V8 çš„æ¶æ„è®¾è®¡ä¸­ï¼Œ**æ¶ˆæ¯å¾ªç¯ï¼ˆMessage Loopï¼‰å’Œæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼‰çš„åˆ›å»ºæ—¶æœºä¸å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼ˆMicroTask Queueï¼‰çš„åˆ›å»ºæ—¶æœºæ˜¯åˆ†ç¦»ä½†ç›¸å…³çš„**ã€‚å®ƒä»¬çš„åä½œå…³ç³»å¦‚ä¸‹ï¼š

------

### â–¶ **1. æ¶ˆæ¯å¾ªç¯ï¼ˆMessage Loopï¼‰çš„åˆ›å»ºæ—¶æœº**

æ¶ˆæ¯å¾ªç¯æ˜¯æµè§ˆå™¨äº‹ä»¶è°ƒåº¦çš„æ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼Œç”± Chromium çš„ä¸»çº¿ç¨‹æˆ–å·¥ä½œçº¿ç¨‹åœ¨åˆå§‹åŒ–æ—¶åˆ›å»ºï¼š

```
// src/base/task/sequence_manager/sequence_manager_impl.cc
void CreateMessageLoopForThread() {
    std::unique_ptr<MessageLoop> message_loop = 
        MessageLoop::CreateCurrentForThread(); // <-- Main/IO/Workerçº¿ç¨‹çš„æ¶ˆæ¯å¾ªç¯
}
```

è¿è¡Œ

- âœ… **ä¸»çº¿ç¨‹**ï¼šåœ¨æµè§ˆå™¨è¿›ç¨‹å¯åŠ¨æ—¶åˆ›å»ºï¼ˆå¦‚ `BrowserMainLoop::InitializeMainThread()`ï¼‰
- âœ… **æ¸²æŸ“çº¿ç¨‹ï¼ˆRendererï¼‰** ï¼šåœ¨æ¸²æŸ“è¿›ç¨‹åˆå§‹åŒ–æ—¶åˆ›å»ºï¼ˆå¦‚ `RenderThreadImpl::Init()`ï¼‰
- âœ… **Web Workerçº¿ç¨‹**ï¼šåœ¨Workerå¯åŠ¨æ—¶åˆ›å»ºï¼ˆå¦‚ `WorkerThread::InitializeOnWorkerThread()`ï¼‰

------

### â–¶ **2. JavaScriptå¼•æ“ï¼ˆV8 Isolateï¼‰å’Œæ¶ˆæ¯å¾ªç¯çš„å…³ç³»**

æ¶ˆæ¯å¾ªç¯æ˜¯æ“ä½œç³»ç»Ÿçº§çš„äº‹ä»¶è°ƒåº¦å™¨ï¼ˆå¤„ç†IPCã€UIäº‹ä»¶ã€å®šæ—¶å™¨ç­‰ï¼‰ï¼Œè€Œ V8 Isolate + MicroTask Queueæ˜¯JSå±‚çš„å¼‚æ­¥è°ƒåº¦æœºåˆ¶ï¼š

```
// src/content/renderer/render_thread_impl.cc (æ¸²æŸ“çº¿ç¨‹åˆå§‹åŒ–)
void RenderThreadImpl::Init() {
    // (1) Chromiumå±‚: åˆ›å»ºæ¶ˆæ¯å¾ªç¯ (æ“ä½œç³»ç»Ÿäº‹ä»¶è°ƒåº¦)
    base::ThreadTaskRunnerHandle runner_handle(message_loop_->task_runner());

    // (2) V8å±‚: JSå¼•æ“åˆå§‹åŒ– (åŒ…æ‹¬é»˜è®¤çš„ MicroTask Queue)
    v8::Isolate* isolate = InitializeV8();
}
```

è¿è¡Œ

- ğŸ”¹ **æ¶ˆæ¯å¾ªç¯å…ˆäºJSå¼•æ“åˆå§‹åŒ–**
  æ¶ˆæ¯å¾ªç¯æ˜¯çº¿ç¨‹çš„åŸºç¡€è®¾æ–½ï¼Œå¿…é¡»å…ˆå­˜åœ¨æ‰èƒ½æ”¯æŒåç»­JSå¼•æ“çš„è¿è¡Œã€‚
- ğŸ”¹ **JSå¼•æ“åˆå§‹åŒ–æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºé»˜è®¤çš„ MicroTask Queue**

------

### â–¶ **3. Web Workerçš„ç‰¹æ®Šæƒ…å†µ**

å¯¹äºWeb Workerçº¿ç¨‹ï¼Œä¸¤è€…çš„åˆ›å»ºé¡ºåºæ›´æ˜ç¡®ï¼š

```
// src/third_party/blink/renderer/core/workers/worker_thread.cc
void WorkerThread::InitializeOnWorkerThread() {
    // (1) Chromiumå±‚: Workerçº¿ç¨‹çš„æ¶ˆæ¯å¾ªç¯
    base::MessageLoop message_loop(base::MessageLoop::TYPE_DEFAULT);

    // (2) V8å±‚: Workerä¸“å±çš„JSç¯å¢ƒå’Œ MicroTask Queue
    std::unique_ptr<v8::MicrotaskQueue> queue = v8::MicrotaskQueue::New(isolate);
}
```

è¿è¡Œ

- âœ… Workerçº¿ç¨‹çš„æ¶ˆæ¯å¾ªç¯å’ŒJSå¼•æ“åˆå§‹åŒ–åœ¨åŒä¸€å‡½æ•°ä¸­å®Œæˆ
- âœ… MicroTask Queueçš„åˆ›å»ºä¾èµ–å·²å­˜åœ¨çš„æ¶ˆæ¯å¾ªç¯

------

### â–¶ **4. Blinkçš„ä»»åŠ¡è°ƒåº¦åä½œ**

Chromiumé€šè¿‡ä»¥ä¸‹æœºåˆ¶åè°ƒæ¶ˆæ¯å¾ªç¯å’ŒJSå¼‚æ­¥è°ƒåº¦ï¼š

| Component       | Responsibility               | Example             |
| --------------- | ---------------------------- | ------------------- |
| Message Loop    | OSçº§äº‹ä»¶è°ƒåº¦                 | IPCã€UIäº‹ä»¶ã€å®šæ—¶å™¨ |
| Task Queue      | Chromiumå±‚å¼‚æ­¥ä»»åŠ¡           | Blink Scheduler     |
| MicroTask Queue | JSå±‚Promise/MutationObserver | V8å¼•æ“å†…éƒ¨          |

```
// src/third_party/blink/renderer/core/frame/local_frame.cc
void LocalFrame::ExecuteJavaScriptTasks() {
    // (1) Chromiumæ¶ˆæ¯å¾ªç¯é©±åŠ¨JSæ‰§è¡Œ
    while (message_loop_->DoWork()) {
        // (2) JSå¼•æ“å¤„ç† MicroTask Queue
        v8_context_->GetMicrotaskQueue()->PerformCheckpoint();
    }
}
```

è¿è¡Œ

------

### â–¶ **å…³é”®ç»“è®º**

1. ğŸ•’ **æ—¶é—´é¡ºåºä¸Š**

   - Chromiumçš„æ¶ˆæ¯å¾ªç¯æ€»æ˜¯å…ˆäºJSå¼•æ“åˆå§‹åŒ–
   - MicroTask Queueåœ¨JSå¼•æ“åˆå§‹åŒ–æ—¶åˆ›å»º

2. ğŸ”— **ä¾èµ–å…³ç³»ä¸Š**

   - JSå¼•æ“éœ€è¦è¿è¡Œåœ¨å·²æœ‰æ¶ˆæ¯å¾ªç¯çš„çº¿ç¨‹ä¸­
   - MicroTaskçš„æ‰§è¡Œä¾èµ–æ¶ˆæ¯å¾ªç¯çš„äº‹ä»¶é©±åŠ¨

3. ğŸ§© **æ¶æ„åˆ†å±‚ä¸Š**

   OS ThreadMessage LoopChromium Task QueuesV8 IsolateMicroTask Queue

è¿™ç§åˆ†å±‚è®¾è®¡ç¡®ä¿äº†ï¼š

- âš¡ Chromiumèƒ½ä¼˜å…ˆè°ƒåº¦é«˜ä¼˜å…ˆçº§çš„ç³»ç»Ÿäº‹ä»¶
- ğŸ”„ JSå±‚çš„å¼‚æ­¥æ“ä½œï¼ˆå¦‚Promiseï¼‰ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹
- ğŸ›¡ï¸ Workerçº¿ç¨‹çš„éš”ç¦»æ€§å¾—åˆ°ä¿è¯